<!doctype html>
<html lang="fr">
	<head>
		<link rel="stylesheet" href="https://openlayers.org/en/v4.3.3/css/ol.css" type="text/css">
		<style>
			body {
				height: 100%;
			}
			.map {
				position: fixed;
				height: 100%;
				width: 100%;
			}
			#popup {
				width: 200px;
				background-color: white;
				padding: 3px;
			}
			#popup-content {
				font-family: sans-serif;
				font-size: 12px;
			}
		</style>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js"></script>
		<script src="https://epsg.io/2154.js"></script>
		<script src="https://openlayers.org/en/v4.3.3/build/ol-debug.js" type="text/javascript"></script>
		<script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
		<title>Atlas Umam</title>
	</head>
	<body>
		<div id="map" class="map"></div>
		<div id="log"></div>
		<div style="display:none;">
			<div id="popup" class="ol-popup">
				<a href="#" id="popup-closer" class="ol-popup-closer"></a>
				<div id="popup-content"></div>
			</div>
		</div>
		<script type="text/javascript">
			var prj2154 = ol.proj.get('EPSG:2154');

			var mailles =  new ol.layer.Vector({
				source: new ol.source.Vector({
					format: new ol.format.GeoJSON({
						featureProjection :'EPSG:3857',
					}),
					url: function (extent, resolution) {
						return 'http://poste.obs.picardie-nature.org/?t=atlas_ng_proxy&file=micro.geojson';
					}

				}),
				style: function (feature,resolution) {
					var n = feature.getProperties().occurences;
					var c = 'rgb(255,0,0)';
					if (n >= 1 && n <= 3) {
						c = 'rgba(254,240,217,0.5)';
					} else if (n >=4 && n<=6) {
						c = 'rgba(253,204,138,0.5)';
					} else if (n >= 7 && n <=9) {
						c = 'rgba(252,141,89,0.5)';
					} else if (n >= 10) {
						c = 'rgba(227,74,51,0.5)';
					}
					var style = new ol.style.Style({
						fill: new ol.style.Fill({color: c}),
						stroke: new ol.style.Stroke({color: 'white', width: 1}),
					});
					return [style];
				},
			});

			var overlay = new ol.Overlay({
				element: document.getElementById('popup'),

			});
			var interaction = new ol.interaction.Select();
			interaction.getFeatures().on("add", function (e) {
				e.preventDefault();
				var p = e.element.getProperties();
				console.log(p);
				var element = overlay.getElement();
				$(element).popover('destroy');
				var coordinates = e.element.getGeometry().getCoordinates()[0][0];
				overlay.setPosition(coordinates);
				overlay.setVisible(true);
				$('#popup-content').html("<h4>"+p["id"]+"</h4><h5>Occurrences <code>"+p["occurences"]+"</code> -  Taxons <code>"+p["species"]+"</code></h5><ul>");
				p["taxons"].forEach(function (e) {
					$('#popup-content').append("<li title=\""+e["nom_s"]+"\">"+e["lib"]+"</li>");
				});
				$('#popup-content').append("</ul>");
				$(element).popover('show');
			});

			var map = new ol.Map({
				target: 'map',
				//overlays: [overlay],
				layers: [
					new ol.layer.Tile({
						source: new ol.source.OSM()
					}),
					mailles,
				],
				view: new ol.View({
				center: ol.proj.fromLonLat([1.9251063,49.7151583]),
				zoom: 8
				})
			});

			map.addOverlay(overlay);
			map.addInteraction(interaction);
    </script>
  </body>
</html>
